<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RA Overlay</title>

  <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.14/dist/browser/signalr.min.js"></script>

  <style>
    :root {
      --alpha: .75;
      --blur: 8px;
      --bg: 32, 34, 38;
      /* r,g,b */
      --scale: 1;
      --minw: 560px;
      /* horizontal min width */
      --vwidth: 240px;
      /* vertical column width (clamped) */
      --pad: 8px;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      overflow: hidden;
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: #f3f4f6
    }

    .corner {
      position: fixed;
      inset: auto auto 0 0;
    }

    /* default: bottom-left */

    .pos-tl {
      top: 0;
      left: 0;
      right: auto;
      bottom: auto
    }

    .pos-tr {
      top: 0;
      right: 0;
      left: auto;
      bottom: auto
    }

    .pos-bl {
      bottom: 0;
      left: 0;
      right: auto;
      top: auto
    }

    .pos-br {
      bottom: 0;
      right: 0;
      left: auto;
      top: auto
    }

    .panel {
      --round: 14px;
      background: rgba(var(--bg), var(--alpha));
      backdrop-filter: blur(var(--blur));
      border-radius: var(--round);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35), inset 0 1px 0 rgba(255, 255, 255, .05);
    }

    #root {
      transform: scale(var(--scale));
      transform-origin: top left;
      padding: var(--pad);
    }

    /* layouts */
    #stack.horizontal {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: var(--minw);
      max-width: calc(var(--minw) + 480px);
    }

    #stack.vertical {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: min(100vw, var(--vwidth));
      /* clamp to pillar width */
      height: 100vh;
    }

    /* header card */
    .header {
      display: grid;
      grid-template-columns: 64px 1fr;
      gap: 10px;
      padding: 10px 12px;
      align-items: center;
    }

    .box {
      width: 64px;
      height: 64px;
      border-radius: 10px;
      background: #111 center/cover no-repeat
    }

    .title {
      font-weight: 700;
      font-size: 15px;
      line-height: 1.2
    }

    .sub {
      opacity: .85;
      font-size: 12px
    }

    .bar-wrap {
      height: 8px;
      background: rgba(255, 255, 255, .12);
      border-radius: 999px;
      margin-top: 8px
    }

    .bar {
      height: 100%;
      width: 0;
      background: #22c55e;
      border-radius: 999px;
      transition: width .35s ease
    }

    /* next up */
    .next {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px
    }

    .badge {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: #111 center/cover no-repeat;
      flex: 0 0 28px
    }

    .next .label {
      font-size: 13px;
      opacity: .9
    }

    .next .name {
      font-weight: 700
    }

    .next .pts {
      opacity: .85;
      font-size: 12px
    }

    /* chips */
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px;
    }

    .chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .08)
    }

    .chip .badge {
      width: 20px;
      height: 20px;
      border-radius: 6px
    }

    /* vertical specifics */
    #stack.vertical .header,
    #stack.vertical .next,
    #stack.vertical .chips {
      width: 100%;
    }

    #stack.vertical .chips {
      flex: 1 1 auto;
      overflow-y: auto;
      flex-direction: column;
      flex-wrap: nowrap;
      padding-right: 4px;
    }

    #stack.vertical .chip {
      width: 100%;
      justify-content: flex-start;
    }

    /* unlock toast: top (horizontal) vs bottom (vertical) */
    .toast {
      position: fixed;
      transition: top .35s ease, bottom .35s ease;
      max-width: 560px;
    }

    .toast .body {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
    }

    .toast .pts {
      opacity: .85;
      font-size: 12px
    }

    .toast.top {
      left: 50%;
      transform: translateX(-50%);
      top: -200px;
    }

    .toast.top.show {
      top: 12px;
    }

    .toast.bottom {
      left: 50%;
      transform: translateX(-50%);
      bottom: -200px;
    }

    .toast.bottom.show {
      bottom: 12px;
    }

    /* keep toast inside the pillar when vertical */
    body.vertical .toast.top,
    body.vertical .toast.bottom {
      left: var(--pad);
      transform: none;
      max-width: var(--vwidth);
    }

    /* compact for very narrow pillars */
    @media (max-width: 260px) {
      .header {
        grid-template-columns: 44px 1fr;
        padding: 8px
      }

      .box {
        width: 44px;
        height: 44px;
        border-radius: 8px
      }

      .title {
        font-size: 13px
      }

      .sub {
        font-size: 11px
      }

      .bar-wrap {
        height: 6px
      }

      .next {
        padding: 6px 8px
      }

      .badge {
        width: 24px;
        height: 24px;
        border-radius: 6px
      }

      .chip {
        padding: 4px 8px
      }

      .chip .badge {
        width: 16px;
        height: 16px
      }

      :root {
        --pad: 6px;
      }
    }

    .focus {
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(0, 0, 0, var(--alpha, 0.75));
      backdrop-filter: blur(var(--blur, 8px));
      border-radius: 14px;
      padding: 12px 14px;
      margin: 8px 0;
    }

    .focus.hidden {
      display: none;
    }

    .focus-badge {
      width: 64px;
      height: 64px;
      border-radius: 10px;
      background-size: cover;
      background-position: center;
      flex: 0 0 auto;
    }

    .focus-body {
      min-width: 0
    }

    .focus-title {
      font-weight: 700;
      font-size: 18px;
    }

    .focus-points {
      opacity: .85;
      margin-top: 2px;
    }

    .focus-desc {
      margin-top: 6px;
      opacity: .9;
      line-height: 1.25;
    }
  </style>
</head>

<body>
  <div id="root" class="corner pos-tl">
    <div id="stack" class="horizontal">
      <div class="panel header" id="hdr">
        <div class="box" id="box"></div>
        <div>
          <div class="title" id="title">Waiting for game…</div>
          <div class="sub"><span id="earned">0</span>/<span id="total">0</span> achievements • <span id="pct">0</span>%
          </div>
          <div class="bar-wrap">
            <div class="bar" id="bar"></div>
          </div>
        </div>
      </div>

      <div class="panel next" id="next" style="display:none">
        <div class="badge" id="nextBadge"></div>
        <div class="label">Next up</div>
        <div class="name" id="nextName"></div>
        <div class="pts" id="nextPts"></div>
      </div>

      <!-- Big focus card for the selected/next achievement -->
      <div id="focus" class="focus hidden">
        <div class="focus-badge"></div>
        <div class="focus-body">
          <div class="focus-title"></div>
          <div class="focus-points"></div>
          <div class="focus-desc"></div>
        </div>
      </div>


      <div class="panel chips" id="chips"></div>
    </div>
  </div>

  <div class="toast top" id="toast">
    <div class="panel body">
      <div class="badge" id="tBadge"></div>
      <div>
        <div class="name" id="tName">Achievement unlocked!</div>
        <div class="pts" id="tPts"></div>
      </div>
    </div>
  </div>

  <!-- preloaded, absolute path for reliability -->
  <audio id="sfx" src="/unlock.mp3" preload="auto"></audio>

  <script>
    // ---- query params ----
    const q = new URLSearchParams(location.search);
    const pos = (q.get('pos') || 'tl').toLowerCase();
    const alpha = parseFloat(q.get('alpha') || '0.75');
    const blur = parseInt(q.get('blur') || '8', 10);
    const bg = (q.get('bg') || '32,34,38');
    const scale = parseFloat(q.get('scale') || '1');
    const minW = parseInt(q.get('width') || '560', 10); // horizontal min width
    const layout = (q.get('layout') || 'horizontal').toLowerCase();
    const vwidth = parseInt(q.get('vwidth') || q.get('width') || '240', 10);
    const maxChips = parseInt(q.get('max') || (layout === 'vertical' ? '40' : '8'), 10);
    const showFocus = (q.get('focus') ?? '1') !== '0';  // &focus=0 to hide big card

    document.documentElement.style.setProperty('--alpha', alpha);
    document.documentElement.style.setProperty('--blur', blur + 'px');
    document.documentElement.style.setProperty('--bg', bg);
    document.documentElement.style.setProperty('--scale', scale);
    document.documentElement.style.setProperty('--minw', minW + 'px');
    document.documentElement.style.setProperty('--vwidth', vwidth + 'px');

    const root = document.getElementById('root');
    root.classList.remove('pos-tl', 'pos-tr', 'pos-bl', 'pos-br');
    root.classList.add('pos-' + pos);

    const stack = document.getElementById('stack');
    stack.classList.remove('horizontal', 'vertical');
    stack.classList.add(layout); // horizontal | vertical

    // toast position & body class for vertical
    const toastEl = document.getElementById('toast');
    toastEl.classList.remove('top', 'bottom');
    toastEl.classList.add(layout === 'vertical' ? 'bottom' : 'top');
    document.body.classList.toggle('vertical', layout === 'vertical');

    // ---- UI helpers ----
    const $ = s => document.querySelector(s);
    const chips = $('#chips');

    function setNowPlaying(payload) {
      $('#title').textContent = `${payload.title} (${payload.consoleName})`;
      $('#box').style.backgroundImage = payload.boxArt ? `url("${payload.boxArt}")` : 'none';
    }
    function setProgress(p) {
      $('#earned').textContent = p.earned ?? 0;
      $('#total').textContent = p.total ?? 0;
      const pct = Math.max(0, Math.min(100, p.percent ?? 0));
      $('#pct').textContent = pct;
      $('#bar').style.width = pct + '%';
    }
    function setRemaining(listOrPayload) {
      const list = (listOrPayload?.remaining || listOrPayload || []);
      const show = list.slice(0, maxChips);
      const chips = document.getElementById('chips');
      chips.innerHTML = '';
      show.forEach(a => {
        const el = document.createElement('div');
        el.className = 'chip';
        el.innerHTML = `
      <div class="badge" style="background-image:url('${a.badge || ''}')"></div>
      <div class="name">${a.title}</div>
    `;
        chips.appendChild(el);
      });
    }
    function setNext(n) {
      const wrap = $('#next');
      if (!n) { wrap.style.display = 'none'; return; }
      $('#nextBadge').style.backgroundImage = n.badge ? `url("${n.badge}")` : 'none';
      $('#nextName').textContent = n.title || '';
      $('#nextPts').textContent = n.points ? `• ${n.points} pts` : '';
      wrap.style.display = '';
    }
    function setFocus(n) {
      const f = document.getElementById('focus');
      if (!showFocus || !n || !n.title) {
        f.classList.add('hidden');
        return;
      }
      f.querySelector('.focus-title').textContent = n.title || '';
      f.querySelector('.focus-points').textContent = (n.points ?? 0) + ' pts';
      f.querySelector('.focus-desc').textContent = n.desc || '';
      f.querySelector('.focus-badge').style.backgroundImage =
        n.badge ? `url("${n.badge}")` : 'none';

      f.classList.remove('hidden');
    }



    // sound helper (reliable/overlapping)
    const sfx = document.getElementById('sfx');
    function playSfx() {
      if (!sfx) return;
      try {
        const a = sfx.cloneNode(true);
        a.play().catch(() => { });
      } catch { }
    }

    let toastTimer;
    function showToast(a) {
      $('#tBadge').style.backgroundImage = a.badge ? `url("${a.badge}")` : 'none';
      $('#tName').textContent = a.title || 'Achievement unlocked!';
      $('#tPts').textContent = a.points ? `${a.points} pts` : '';
      const t = document.getElementById('toast');
      t.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => t.classList.remove('show'), 3500);
      playSfx();
    }

    // ---- SignalR ----
    const hub = new signalR.HubConnectionBuilder()
      .withUrl('/overlayhub')
      .withAutomaticReconnect()
      .build();

    hub.on('now-playing', setNowPlaying);
    hub.on('progress', setProgress);
    hub.on('remaining', setRemaining);
    hub.on('next', n => {setNext(n); setFocus(n);});
    hub.on('achievement', showToast);

    hub.start().catch(err => console.error(err));
  </script>
</body>

</html>